<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>日本在住外国人向け eGFR 計算ツール</title>
<style>
  :root{
    --bg:#0b1220;
    --glass:rgba(255,255,255,.12);
    --glass-strong:rgba(255,255,255,.18);
    --border:rgba(255,255,255,.25);
    --text:#eaf2ff;
    --muted:#b9c6e1;
    --accent:#7fb0ff;
    --ok:#5bd48b;
    --warn:#ffd36e;
    --bad:#ff7f7f;
    --shadow: 0 10px 40px rgba(0,0,0,.35);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 80% -10%, #1f2a44 0%, transparent 60%),
      radial-gradient(1000px 600px at -10% 120%, #19253e 0%, transparent 60%),
      linear-gradient(180deg, #0b1220, #0a1020 50%, #080e1b 100%);
    min-height:100%;
    -webkit-font-smoothing: antialiased;
  }
  .wrap{
    max-width:960px; margin: min(5vw,28px) auto; padding: clamp(10px,3vw,22px);
  }
  .card{
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px) saturate(120%);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
  }
  header.card{
    padding:18px 16px 12px;
  }
  header h1{
    margin:0 0 6px; font-size: clamp(18px,4.5vw,24px); letter-spacing:.04em;
  }
  header p{margin:.25rem 0 .5rem; color:var(--muted); font-size: .95rem;}
  .grid{
    display:grid; gap:14px;
    grid-template-columns:1fr;
  }
  @media (min-width:760px){
    .grid{ grid-template-columns: 1.1fr .9fr; }
  }
  .panel{ padding:16px; }
  .field{ margin:10px 0 12px; }
  .label{ font-size:.93rem; color:var(--muted); margin:0 0 6px; display:block;}
  input, select, button, textarea{
    width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
    background: rgba(255,255,255,.06); color:var(--text); outline:none;
  }
  input::placeholder{ color:#c7d2e7aa; }
  .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  .chips{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip{
    padding:8px 10px; border-radius:999px; border:1px solid var(--border);
    background: rgba(255,255,255,.06); font-size:.9rem; cursor:pointer; user-select:none;
  }
  .chip input{display:none}
  .chip.active{ outline:2px solid var(--accent); background:rgba(127,176,255,.1); }
  .muted{ color:var(--muted); font-size:.9rem;}
  .btn{
    display:inline-flex; gap:8px; align-items:center; justify-content:center; cursor:pointer;
    background: linear-gradient(180deg, #7fb0ff, #5a8fe9);
    border: none; color:#0b1220; font-weight:700; box-shadow: 0 6px 22px rgba(90,143,233,.45);
  }
  .btn:active{ transform: translateY(1px); }
  .results{ margin-top:14px; display:grid; gap:12px; }
  .result-card{
    padding:14px; border-radius:16px; border:1px solid var(--border); background: var(--glass-strong);
  }
  .title{ font-weight:700; }
  .kicker{ font-size:.82rem; color:var(--muted); }
  .value{ font-size: clamp(22px,6vw,30px); font-weight:800; margin:6px 0 4px;}
  .stage{ font-size:.9rem; font-weight:700; }
  .ok{ color:var(--ok);} .warn{ color:var(--warn);} .bad{ color:var(--bad);}
  details{ margin-top:8px; }
  summary{ cursor:pointer; color:var(--accent); }
  .pill{
    display:inline-block; padding:4px 8px; border-radius:999px; font-size:.78rem;
    background:#2a3650; color:#cfe0ff; border:1px solid #3b4a6c;
  }
  footer.card{ padding:14px; margin-top:14px; }
  a { color:#a8c7ff; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>日本在住外国人向け eGFR 計算ツール（sCrベース）</h1>
      <p class="muted">日本の臨床現場で使いやすいUIで、国籍に応じた推奨/類縁の推算式をまとめて計算。身長・体重を入れるとBSA補正解除（mL/min）も表示。<span class="pill">成人用</span></p>
    </header>

    <div class="grid">
      <!-- 左：入力 -->
      <section class="panel card">
        <div class="field">
          <label class="label">国籍 / 地域を選択</label>
          <select id="nationality">
            <option value="JP">日本人（参考：JSN式）</option>
            <option value="CN">中国（中国式あり／CKD-EPI推奨）</option>
            <option value="TH">タイ（タイ独自式あり）</option>
            <option value="KR">韓国（CKD-EPI推奨）</option>
            <option value="VN">ベトナム（近縁：タイ式も参考）</option>
            <option value="PH">フィリピン（近縁：タイ式も参考）</option>
            <option value="NP">ネパール（近縁：タイ式も参考）</option>
            <option value="WH">白人（CKD-EPI 2021推奨）</option>
            <option value="AF">黒人（CKD-EPI 2021推奨）</option>
            <option value="OT">その他（CKD-EPI 2021推奨）</option>
          </select>
          <p class="muted" id="natNote" style="margin:.4rem 0 0;"></p>
        </div>

        <div class="field row">
          <div>
            <label class="label">年齢（歳）</label>
            <input id="age" type="number" inputmode="numeric" placeholder="例）65" />
          </div>
          <div>
            <label class="label">性別</label>
            <select id="sex">
              <option value="male">男性</option>
              <option value="female">女性</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label class="label">血清クレアチニン sCr（mg/dL）</label>
          <input id="scr" type="number" step="0.01" inputmode="decimal" placeholder="例）1.02" />
        </div>

        <details>
          <summary>オプション（体格・その他）</summary>
          <div class="field row" style="margin-top:10px;">
            <div>
              <label class="label">身長（cm）</label>
              <input id="height" type="number" step="0.1" inputmode="decimal" placeholder="例）170" />
            </div>
            <div>
              <label class="label">体重（kg）</label>
              <input id="weight" type="number" step="0.1" inputmode="decimal" placeholder="例）65" />
            </div>
          </div>
          <div class="field">
            <label class="label">Cockcroft–Gault（参考）を同時表示</label>
            <select id="showCG">
              <option value="yes">表示する（体重を使用）</option>
              <option value="no">表示しない</option>
            </select>
          </div>
        </details>

        <div class="field">
          <label class="label">この国籍でよく使う/参考になる推算式（複数選択可）</label>
          <div id="formulaChips" class="chips"></div>
          <p class="muted" style="margin-top:6px;">※ 推奨＝その国籍に第一選択として勧められる/検証の厚い式、参考＝地理・人種で近縁または歴史的比較用</p>
        </div>

        <div class="field">
          <button class="btn" id="calcBtn">計算する</button>
        </div>
      </section>

      <!-- 右：結果 -->
      <section class="panel card">
        <div class="field">
          <div class="label">計算結果</div>
          <div id="results" class="results"></div>
        </div>
      </section>
    </div>

    <footer class="card">
      <div class="kicker">注意</div>
      <ul class="muted">
        <li>本ツールは<b>成人</b>用のsCr推算式です（急性腎障害などsCrが急変する状況では不正確）。</li>
        <li>結果は<b>推算</b>です。境界例・極端な体格やサルコペニアでは<b>シスタチンC</b>や<b>実測GFR</b>（核医学など）をご検討ください。</li>
        <li>BSA未入力時は<b>標準化eGFR（mL/min/1.73m²）</b>のみ表示。身長・体重を入れると<b>非標準化（mL/min）</b>も併記します。</li>
      </ul>
    </footer>
  </div>

<script>
/** -------------------------
 *  計算ロジック
 *------------------------- */
// BSA (DuBois)
function bsaDuBois(heightCm, weightKg){
  if(!heightCm || !weightKg) return null;
  return 0.007184 * Math.pow(weightKg, 0.425) * Math.pow(heightCm, 0.725);
}
// JSN 日本人式（sCr・成人）
function egfr_jsn(age, sex, scr){
  // eGFR = 194 × Scr^−1.094 × Age^−0.287 × (女性0.739)
  let base = 194 * Math.pow(scr, -1.094) * Math.pow(age, -0.287);
  if(sex==='female') base *= 0.739;
  return base;
}
// CKD-EPI 2021（creatinine, race-free）
function egfr_ckdepi2021(age, sex, scr){
  const k = (sex==='female') ? 0.7 : 0.9;
  const a = (sex==='female') ? -0.241 : -0.302; // NKF/NIDDK公表値
  const minPart = Math.min(scr/k, 1);
  const maxPart = Math.max(scr/k, 1);
  return 142 * Math.pow(minPart, a) * Math.pow(maxPart, -1.200) * Math.pow(0.9938, age) * (sex==='female' ? 1.012 : 1);
}
// CKD-EPI 2009（比較用：非黒人 / 黒人）
function egfr_ckdepi2009(age, sex, scr, isBlack=false){
  const k = (sex==='female') ? 0.7 : 0.9;
  const a = (sex==='female') ? -0.329 : -0.411;
  const minPart = Math.min(scr/k, 1);
  const maxPart = Math.max(scr/k, 1);
  let val = 141 * Math.pow(minPart, a) * Math.pow(maxPart, -1.209) * Math.pow(0.993, age) * (sex==='female' ? 1.018 : 1);
  if(isBlack) val *= 1.159;
  return val;
}
// 中国C-MDRD（中国係数1.233）
function egfr_c_mdrd(age, sex, scr){
  let v = 175 * Math.pow(scr, -1.154) * Math.pow(age, -0.203);
  if(sex==='female') v *= 0.742;
  v *= 1.233;
  return v;
}
// 中国 Xiangya 2019（mg/dL対応式）
function egfr_xiangya2019(age, sex, scr){
  // eGFR = 2374.78 × Scr^-0.54753 × Age^-0.25011 × (女性 0.8526126)
  let v = 2374.78 * Math.pow(scr, -0.54753) * Math.pow(age, -0.25011);
  if(sex==='female') v *= 0.8526126;
  return v;
}
// タイ：MDRD再表現 × 1.129
function egfr_thai_mdrd(age, sex, scr){
  let v = 175 * Math.pow(scr, -1.154) * Math.pow(age, -0.203);
  if(sex==='female') v *= 0.742;
  v *= 1.129; // Thai racial factor
  return v;
}
// タイ独自式（Praditpornsilpa 2011）
function egfr_thai_independent(age, sex, scr){
  let v = 375.5 * Math.pow(scr, -0.848) * Math.pow(age, -0.364);
  if(sex==='female') v *= 0.712;
  return v;
}
// Cockcroft–Gault（参考：mL/min）
function ccr_cg(age, sex, scr, weightKg){
  if(!weightKg) return null;
  let v = ((140 - age) * weightKg) / (72 * scr);
  if(sex==='female') v *= 0.85;
  return v;
}

// KDIGO Gステージ（目安）
function kdigoStage(egfr){
  if(egfr >= 90) return {g:"G1", cls:"ok"};
  if(egfr >= 60) return {g:"G2", cls:"ok"};
  if(egfr >= 45) return {g:"G3a", cls:"warn"};
  if(egfr >= 30) return {g:"G3b", cls:"warn"};
  if(egfr >= 15) return {g:"G4", cls:"bad"};
  return {g:"G5", cls:"bad"};
}

/** -------------------------
 *  フォーミュラ定義と国籍マッピング
 *------------------------- */
const FORMULAS = {
  JSN: {
    id:"JSN",
    name:"JSN日本人式（sCr）",
    calc: egfr_jsn,
    kind:"推奨（日本人）",
    cite:"日本腎臓学会（成人人日本式）",
    explain:`日本人データから導出された3変数モデル。eGFR = 194 × sCr^-1.094 × 年齢^-0.287（女性は×0.739）。酵素法sCr・成人用。`,
    refs:["JSN 2013/2009"]
  },
  CKD2021: {
    id:"CKD2021",
    name:"CKD-EPI 2021（race-free, sCr）",
    calc: egfr_ckdepi2021,
    kind:"推奨（国籍横断）",
    cite:"NKF/ASN・KDIGO推奨（人種項目なし）",
    explain:`2021年改訂の国際式。142 × min(sCr/k,1)^α × max(sCr/k,1)^−1.200 × 0.9938^年齢 ×（女性1.012）。k=0.7/0.9, α=女性-0.241/男性-0.302。`,
    refs:["NKF/NIDDK 2021"]
  },
  CKD2009NB: {
    id:"CKD2009NB",
    name:"CKD-EPI 2009（非黒人, sCr）",
    calc: (a,s,cr)=>egfr_ckdepi2009(a,s,cr,false),
    kind:"参考（歴史的比較）",
    cite:"CKD-EPI 2009（非黒人）",
    explain:`141 × min(sCr/k,1)^α × max(sCr/k,1)^−1.209 × 0.993^年齢 ×（女性1.018）。k=0.7/0.9, α=女性-0.329/男性-0.411。`,
    refs:["CKD-EPI 2009"]
  },
  CKD2009BL: {
    id:"CKD2009BL",
    name:"CKD-EPI 2009（黒人, sCr）",
    calc: (a,s,cr)=>egfr_ckdepi2009(a,s,cr,true),
    kind:"参考（歴史的比較）",
    cite:"CKD-EPI 2009（黒人係数あり）",
    explain:`上記2009式に黒人係数1.159を乗じる版。2021年以降はrace-free式が推奨。`,
    refs:["CKD-EPI 2009"]
  },
  C_MDRD: {
    id:"C_MDRD",
    name:"C-MDRD（中国補正1.233）",
    calc: egfr_c_mdrd,
    kind:"推奨/候補（中国）",
    cite:"MDRDの中国係数1.233",
    explain:`175 × sCr^-1.154 × 年齢^-0.203 ×（女性0.742）× 1.233（中国係数）。`,
    refs:["C-MDRD"]
  },
  XIANGYA: {
    id:"XIANGYA",
    name:"Xiangya 2019（中国式, sCr）",
    calc: egfr_xiangya2019,
    kind:"推奨/候補（中国, 最新）",
    cite:"Xiangya 2019",
    explain:`2374.78 × sCr^-0.54753 × 年齢^-0.25011 ×（女性0.8526126）。中国人で高精度（P30向上報告）。`,
    refs:["Xiangya 2019"]
  },
  TH_MDRD: {
    id:"TH_MDRD",
    name:"MDRD × 1.129（タイ係数）",
    calc: egfr_thai_mdrd,
    kind:"推奨/候補（タイ）",
    cite:"MDRDのタイ係数1.129",
    explain:`175 × sCr^-1.154 × 年齢^-0.203 ×（女性0.742）× 1.129（タイ係数）。`,
    refs:["Thai MDRD"]
  },
  TH_INDEP: {
    id:"TH_INDEP",
    name:"Thai独自式 2011（sCr）",
    calc: egfr_thai_independent,
    kind:"推奨/候補（タイ）",
    cite:"Praditpornsilpa 2011",
    explain:`375.5 × sCr^-0.848 × 年齢^-0.364 ×（女性0.712）。`,
    refs:["Thai Eq (2011)"]
  }
};

// 国籍→初期表示（推奨ON/参考候補）
const NAT_MAP = {
  JP: {note:"日本人にはJSN式が標準。比較用にCKD-EPIも選択可能。", on:["JSN","CKD2021"], extra:["CKD2009NB"]},
  CN: {note:"中国ではC-MDRDやXiangya式の報告あり。国際比較用にCKD-EPI 2021も。", on:["CKD2021","C_MDRD","XIANGYA"], extra:["CKD2009NB"]},
  TH: {note:"タイは独自式やMDRD×1.129が報告。CKD-EPIも参考に。", on:["TH_INDEP","TH_MDRD","CKD2021"], extra:["CKD2009NB"]},
  KR: {note:"韓国はCKD-EPIが一般的。JSNは過小推定傾向の報告あり。", on:["CKD2021"], extra:["CKD2009NB"]},
  VN: {note:"東南アジア近縁としてタイ式も参考候補。", on:["CKD2021"], extra:["TH_INDEP","TH_MDRD","CKD2009NB"]},
  PH: {note:"東南アジア近縁としてタイ式も参考候補。", on:["CKD2021"], extra:["TH_INDEP","TH_MDRD","CKD2009NB"]},
  NP: {note:"南アジアでは体格差が大。まずCKD-EPI、比較にタイ式も参考。", on:["CKD2021"], extra:["TH_INDEP","TH_MDRD","CKD2009NB"]},
  WH: {note:"白人はCKD-EPI 2021を第一選択。", on:["CKD2021"], extra:["CKD2009NB"]},
  AF: {note:"黒人は現行はrace-free CKD-EPI 2021を推奨（2009は黒人係数あり・参考）。", on:["CKD2021"], extra:["CKD2009BL","CKD2009NB"]},
  OT: {note:"国籍が多様な場合はrace-free CKD-EPI 2021を基本に。", on:["CKD2021"], extra:["CKD2009NB"]}
};

/** -------------------------
 *  UI 初期化
 *------------------------- */
const chipsBox = document.getElementById('formulaChips');
const natSel = document.getElementById('nationality');
const natNote = document.getElementById('natNote');
const resultsBox = document.getElementById('results');

function renderChips(nat){
  chipsBox.innerHTML = '';
  const map = NAT_MAP[nat];
  natNote.textContent = map.note;
  const toShow = [...map.on, ...map.extra];
  for(const id of toShow){
    const f = FORMULAS[id];
    const chip = document.createElement('label');
    chip.className = 'chip' + (map.on.includes(id) ? ' active':'');
    chip.title = f.kind + '｜' + f.cite;
    chip.dataset.id = id;
    chip.innerHTML = `<input type="checkbox" ${map.on.includes(id) ? 'checked':''}/> ${f.name}`;
    chip.addEventListener('click', (e)=>{
      if(e.target.tagName.toLowerCase()==='input') return;
      const cb = chip.querySelector('input');
      cb.checked = !cb.checked;
      chip.classList.toggle('active', cb.checked);
    });
    chipsBox.appendChild(chip);
  }
}
renderChips(natSel.value);
natSel.addEventListener('change', ()=>renderChips(natSel.value));

/** -------------------------
 *  計算
 *------------------------- */
function toNum(id){ const v = parseFloat(document.getElementById(id).value); return isFinite(v)? v: null; }
function selVal(id){ return document.getElementById(id).value; }

document.getElementById('calcBtn').addEventListener('click', ()=>{
  resultsBox.innerHTML = '';
  const age = toNum('age');
  const sex = selVal('sex');
  const scr = toNum('scr');
  const h = toNum('height');
  const w = toNum('weight');
  const showCG = (selVal('showCG')==='yes');

  // 入力バリデーション
  const errs = [];
  if(!age || age<18) errs.push('年齢は18歳以上の整数/数値を入力してください。');
  if(!scr || scr<=0) errs.push('sCr（mg/dL）は正の数値を入力してください。');
  if(errs.length){
    const e = document.createElement('div');
    e.className='result-card';
    e.innerHTML = `<div class="title">入力エラー</div><ul class="muted">${errs.map(x=>`<li>${x}</li>`).join('')}</ul>`;
    resultsBox.appendChild(e);
    return;
  }
  const bsa = (h && w) ? bsaDuBois(h, w) : null;

  // 選択式
  const checkedIds = Array.from(chipsBox.querySelectorAll('.chip input:checked')).map(cb=>cb.parentElement.dataset.id);
  if(checkedIds.length===0){
    const e = document.createElement('div');
    e.className='result-card';
    e.innerHTML = `<div class="title">式が未選択</div><div class="muted">少なくとも1つの推算式を選択してください。</div>`;
    resultsBox.appendChild(e);
    return;
  }

  // 計算＆描画
  checkedIds.forEach(id=>{
    const f = FORMULAS[id];
    const val = f.calc(age, sex, scr);
    const stage = kdigoStage(val);
    const unIndexed = bsa ? (val * (bsa/1.73)) : null;

    const card = document.createElement('div');
    card.className = 'result-card';
    card.innerHTML = `
      <div class="kicker">${f.kind}・<span class="pill">${f.cite}</span></div>
      <div class="title">${f.name}</div>
      <div class="value">${val.toFixed(0)} <span class="muted">mL/min/1.73m²</span></div>
      ${unIndexed ? `<div class="muted">非標準化（体表面積${bsa.toFixed(2)}m²換算）：<b>${unIndexed.toFixed(0)}</b> mL/min</div>`:''}
      <div class="stage ${stage.cls}" style="margin-top:4px;">KDIGOステージ目安：<b>${stage.g}</b></div>
      <details>
        <summary>この式の説明と根拠を表示</summary>
        <div style="margin-top:6px;">
          <div class="muted" style="line-height:1.7;">
            ${f.explain}
          </div>
          <div class="muted" style="margin-top:6px;">参考文献（要旨）：${f.refs.map(r=>`<span class="pill">${r}</span>`).join(' ')}</div>
        </div>
      </details>
    `;
    resultsBox.appendChild(card);
  });

  // Cockcroft–Gault（参考）
  if(showCG){
    const ccr = ccr_cg(age, sex, scr, w);
    const card = document.createElement('div');
    card.className = 'result-card';
    card.innerHTML = `
      <div class="kicker">参考（薬物投与量調整などに用いられることが多い）</div>
      <div class="title">Cockcroft–Gault（体重使用, 未標準化）</div>
      <div class="value">${ccr? ccr.toFixed(0):'—'} <span class="muted">mL/min</span></div>
      <details>
        <summary>計算式の説明</summary>
        <div class="muted" style="margin-top:6px;">
          (140 − 年齢) × 体重(kg) ÷ (72 × sCr)（女性は×0.85）。BSA標準化は行いません。臨床では体重の選択（実測/理想/調整）が議論となる点に注意。
        </div>
      </details>
    `;
    resultsBox.appendChild(card);
  }
});
</script>
</body>
</html>